\ProvidesPackage{CommMatrix}

\usepackage{datatool}
\usepackage{xparse}
\usepackage{etoolbox}
\usepackage{tikz}
\usetikzlibrary{matrix,calc,fpu,fit,positioning}

\usepackage{calc}

\tikzstyle{comm_matrix}=[
		matrix of nodes,
		row sep=-\pgflinewidth,
		column sep=-\pgflinewidth,
		nodes={
			draw=black,
			align=center,
		},
		text width=3em,
		text height=3em,
	]

\def\myHuge{\fontsize{30pt}{30pt}\selectfont}

\NewDocumentCommand\CommMatrix{mO{}O{100}O{true}O{false}}{\begin{tikzpicture}
	
	% parse arguments
	\def\true{true}
	\def\addedcode{#2} % added tikz code
	\def\scaling{#3}   % scale matrix values by a fixed amount
	\def\putthreadids{#4} % put thread ids at borders
	\def\putnums{#5}   % put values in each cell

	%define variable name of table
	\ifx\mytablename\undefined
		\global\def\mytablename{A}
	\else
		\global\expandafter\edef\expandafter\mytablename\expandafter{\mytablename X}
	\fi
	\edef\tablename{\mytablename{}}

	% load content from file into \tablename
	\DTLloaddb[noheader]{\tablename{}}{#1}

	% helper function to fill matrix content
	\let\mymatrixcontent\empty

	\providecommand\myadd[1]{%
	\begingroup\edef\x{\endgroup%
	   \noexpand\gappto\noexpand\mymatrixcontent{\noexpand\node[fill=black!##1]{\ifx\putnums\true##1\fi}; \& }}\x%
	}%

	% find max value
	\def\vmax{0}
	\DTLforeach*{\tablename{}}{}{\DTLforeachkeyinrow{\myval}{\ifnum\myval>\vmax\edef\vmax{\myval}\fi}}

	\pgfkeys{/pgf/fpu/output format=fixed}
	% fill matrix content; if you don't understand this line, neither do I
	\DTLforeach*{\tablename{}}{}{\gappto\mymatrixcontent{ }\DTLforeachkeyinrow{\myval}{\pgfkeys{/pgf/fpu}\pgfmathparse{round(\myval/\vmax*\scaling)}\pgfmathint{\pgfmathresult}\myadd{\pgfmathresult}\pgfkeys{/pgf/fpu=false}}\gappto\mymatrixcontent{ \\ }}

	% put matrix content
	\matrix (mymatrix) [comm_matrix, ampersand replacement = \&]
	{
		\mymatrixcontent
	};

	% put thread IDs
	\ifx\putthreadids\true
		% row IDs
		\DTLforeach*{\tablename{}}{}{\node [font=\myHuge, left = 1mm of mymatrix-\DTLcurrentindex-1] {\pgfmathparse{int(\DTLcolumncount{\tablename{}}-\DTLcurrentindex)} \pgfmathresult}; }

		% column IDs
		\DTLforeach*{\tablename{}}{}{\node [font=\myHuge, below = 1mm of mymatrix-\DTLrowcount{\tablename{}}-\DTLcurrentindex] {\pgfmathparse{int(\DTLcurrentindex-1)} \pgfmathresult}; }
	\fi

	% added tikz code
	\addedcode

\end{tikzpicture}}
